// Generated by CoffeeScript 2.7.0
(function() {
  // Socket.io connection
  var controllerScreen, errorMsg, gameCodeInput, joinBtn, joinGame, joinScreen, joystickActive, joystickCenter, joystickContainer, joystickKnob, maxDistance, resetJoystick, shootBtn, socket, updateJoystick;

  socket = io();

  // DOM Elements
  joinScreen = document.getElementById('join-screen');

  controllerScreen = document.getElementById('controller-screen');

  gameCodeInput = document.getElementById('game-code-input');

  joinBtn = document.getElementById('join-btn');

  errorMsg = document.getElementById('error-msg');

  joystickContainer = document.getElementById('joystick-container');

  joystickKnob = document.getElementById('joystick-knob');

  shootBtn = document.getElementById('shoot-btn');

  // Joystick state
  joystickActive = false;

  joystickCenter = {
    x: 0,
    y: 0
  };

  maxDistance = 45;

  // Join game handler
  joinGame = function() {
    var code;
    code = gameCodeInput.value.trim().toUpperCase();
    if (code.length < 4) {
      errorMsg.textContent = 'Please enter a valid game code';
      return;
    }
    errorMsg.textContent = '';
    socket.emit('type', 'client');
    return socket.emit('join-game', code);
  };

  joinBtn.addEventListener('click', joinGame);

  gameCodeInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      return joinGame();
    }
  });

  // Socket events
  socket.on('join-success', function() {
    joinScreen.classList.add('hidden');
    return controllerScreen.classList.add('active');
  });

  socket.on('join-error', function(msg) {
    return errorMsg.textContent = msg;
  });

  // Handle death event from server
  socket.on('you-died', function() {
    document.body.style.background = '#2a0a0a';
    return controllerScreen.innerHTML = `<div style="text-align: center; width: 100%;">
  <h1 style="font-size: 3rem; color: #e94560;">YOU DIED</h1>
  <p style="color: #888; margin-top: 1rem;">Better luck next time...</p>
</div>`;
  });

  // Calculates joystick position and emits movement data
  updateJoystick = function(clientX, clientY) {
    var deltaX, deltaY, distance, normalizedX, normalizedY, rect;
    rect = joystickContainer.getBoundingClientRect();
    joystickCenter.x = rect.left + rect.width / 2;
    joystickCenter.y = rect.top + rect.height / 2;
    deltaX = clientX - joystickCenter.x;
    deltaY = clientY - joystickCenter.y;
    distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    
    // Clamp to max distance
    if (distance > maxDistance) {
      deltaX = (deltaX / distance) * maxDistance;
      deltaY = (deltaY / distance) * maxDistance;
      distance = maxDistance;
    }
    
    // Update knob position
    joystickKnob.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
    
    // Normalize values to -1 to 1 range
    normalizedX = deltaX / maxDistance;
    normalizedY = deltaY / maxDistance;
    return socket.emit('joystick', {
      x: normalizedX,
      y: normalizedY
    });
  };

  // Reset joystick to center
  resetJoystick = function() {
    joystickKnob.style.transform = 'translate(0px, 0px)';
    return socket.emit('joystick', {
      x: 0,
      y: 0
    });
  };

  // Touch events for joystick
  joystickContainer.addEventListener('touchstart', function(e) {
    var touch;
    e.preventDefault();
    joystickActive = true;
    touch = e.touches[0];
    return updateJoystick(touch.clientX, touch.clientY);
  });

  joystickContainer.addEventListener('touchmove', function(e) {
    var touch;
    e.preventDefault();
    if (!joystickActive) {
      return;
    }
    touch = e.touches[0];
    return updateJoystick(touch.clientX, touch.clientY);
  });

  joystickContainer.addEventListener('touchend', function(e) {
    e.preventDefault();
    joystickActive = false;
    return resetJoystick();
  });

  // Mouse events for joystick (for desktop testing)
  joystickContainer.addEventListener('mousedown', function(e) {
    joystickActive = true;
    return updateJoystick(e.clientX, e.clientY);
  });

  document.addEventListener('mousemove', function(e) {
    if (!joystickActive) {
      return;
    }
    return updateJoystick(e.clientX, e.clientY);
  });

  document.addEventListener('mouseup', function() {
    if (!joystickActive) {
      return;
    }
    joystickActive = false;
    return resetJoystick();
  });

  // Shoot button events
  shootBtn.addEventListener('touchstart', function(e) {
    e.preventDefault();
    shootBtn.classList.add('pressed');
    return socket.emit('shoot', true);
  });

  shootBtn.addEventListener('touchend', function(e) {
    e.preventDefault();
    shootBtn.classList.remove('pressed');
    return socket.emit('shoot', false);
  });

  shootBtn.addEventListener('mousedown', function() {
    shootBtn.classList.add('pressed');
    return socket.emit('shoot', true);
  });

  shootBtn.addEventListener('mouseup', function() {
    shootBtn.classList.remove('pressed');
    return socket.emit('shoot', false);
  });

}).call(this);
